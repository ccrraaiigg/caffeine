name: Repost GitHub Issue Comments to Discord (Fancy)

on:
  issue_comment:
    types: [created]

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue comment to Discord with embed
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          AUTHOR_NAME="${{ github.event.comment.user.login }}"
          AUTHOR_AVATAR="${{ github.event.comment.user.avatar_url }}"
          COMMENT_URL="${{ github.event.comment.html_url }}"
          ISSUE_URL="${{ github.event.issue.html_url }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          COMMENT_BODY_RAW="${{ github.event.comment.body }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq -n --arg author "$AUTHOR_NAME" \
                --arg avatar "$AUTHOR_AVATAR" \
                --arg comment_url "$COMMENT_URL" \
                --arg issue_url "$ISSUE_URL" \
                --arg issue_title "$ISSUE_TITLE" \
                --arg comment "$COMMENT_BODY_RAW" \
                --arg time "$TIMESTAMP" \
          '{
            "embeds": [{
              "title": "ðŸ’¬ Comment on Issue: \($issue_title)",
              "url": $comment_url,
              "author": {
                "name": $author,
                "url": ("https://github.com/" + $author),
                "icon_url": $avatar
              },
              "description": $comment,
              "footer": {
                "text": "Posted via GitHub Actions â€¢ View issue thread",
                "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
              },
              "timestamp": $time,
              "color": 5793266
            }]
          }' > payload.json

          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            --data-binary @payload.json
